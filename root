{"version":1,"ops":[{"type":1,"author":{"id":"1e82e80d6a78dea3717cc9888e5a57ab5eea2a8f"},"timestamp":1621727881,"metadata":{"github-id":"MDU6SXNzdWU4OTg5MDMwMTU=","github-url":"https://github.com/lstein/Perl-GD/issues/37","origin":"github"},"title":"GD::Simple-\u003efontMetrics doesn't seem to do what documentation says","message":"The GD::Simple-\u003efontMetrics() function doesn't seem to be coded in such a\nway that it does what the documentation says. The documentation at\nhttps://metacpan.org/pod/GD::Simple says that the metrics are defined in\nterms of the rendering of the letters m, j, and d, but the code at\nhttps://metacpan.org/release/GD/source/lib/GD/Simple.pm actually only\ndoes test renderings of m and j, never d.\n\nThe documentation says that the lineheight is defined as\n\"the distance from the bottom of the 'j' to the top of the 'd'\".\nThis sounds like the intention is to return the height of the string\n'jd'. This would automatically be greater than the xheight. Actually\nwhat it seems to calculate is the whitespace in the middle of \"m\\nm\",\nwhich is much smaller.\n\nHere is some test code:\n\nuse GD::Simple;\nuse strict;\nmy $img = GD::Simple-\u003enew(100,100); # dummy height and width\nmy $font = $img-\u003efont('/usr/share/fonts/truetype/ttf-bitstream-vera/Vera.ttf',48);\nmy $metrics = $img-\u003efontMetrics;\nprint \"['xheight':\",$metrics-\u003e{'xheight'},\n  \",'ascent':\",$metrics-\u003e{'ascent'},\n  \",'descent':\",$metrics-\u003e{'descent'},\n  \",'lineheight':\",$metrics-\u003e{'lineheight'},\n  \",'leading':\",$metrics-\u003e{'leading'},\n  \"]\\n\"\n;\n\nThe output is:\n\n['xheight':38,'ascent':13,'descent':13,'lineheight':29,'leading':3]\n\nI think the lineheight is wrong (too small), and the ascent is really\njust a copy of the descent.\n\nHere is a patch, which I think makes the code do what was intended and also clears up possible ambiguities in the documentation.\n\n740,741c740\n\u003c   lineheight   the distance from the bottom of the 'j' to the top of\n\u003c                the 'd'\n---\n\u003e   lineheight   the distance from the bottom to the top of the string 'jd'\n743c742\n\u003c   leading      the distance between two adjacent lines\n---\n\u003e   leading      the height of the empty space between two adjacent lines\n771,773c770,773\n\u003c     my @mbounds   = GD::Image-\u003estringFT($self-\u003efgcolor,$font,\n\u003c \t\t\t\t\t$self-\u003efontsize,0,\n\u003c \t\t\t\t\t0,0,'m');\n---\n\u003e     my @mbounds   = GD::Image-\u003estringFT($self-\u003efgcolor,$font,$self-\u003efontsize,0,0,0,'m');\n\u003e     my @jbounds   = GD::Image-\u003estringFT($self-\u003efgcolor,$font,$self-\u003efontsize,0,0,0,'j');\n\u003e     my @dbounds   = GD::Image-\u003estringFT($self-\u003efgcolor,$font,$self-\u003efontsize,0,0,0,'d');\n\u003e     my @mmbounds  = GD::Image-\u003estringFT($self-\u003efgcolor,$font,$self-\u003efontsize,0,0,0,\"m\\nm\");\n775,778c775\n\u003c     my @jbounds   = GD::Image-\u003estringFT($self-\u003efgcolor,$font,\n\u003c \t\t\t\t\t$self-\u003efontsize,0,\n\u003c \t\t\t\t\t0,0,'j');\n\u003c     my $ascent    = $mbounds[7]-$jbounds[7];\n---\n\u003e     my $ascent    = $mbounds[7]-$dbounds[7];\n780,786c777,780\n\u003c \n\u003c     my @mmbounds  = GD::Image-\u003estringFT($self-\u003efgcolor,$font,\n\u003c \t\t\t\t\t$self-\u003efontsize,0,\n\u003c \t\t\t\t\t0,0,\"m\\nm\");\n\u003c     my $twolines  = $mmbounds[3]-$mmbounds[5];\n\u003c     my $lineheight  = $twolines - 2*$xheight;\n\u003c     my $leading     = $lineheight - $ascent - $descent;\n---\n\u003e  \n\u003e     my $mm_height  = $mmbounds[3]-$mmbounds[5];\n\u003e     my $lineheight  = $xheight+$ascent+$descent;\n\u003e     my $leading     = $mm_height - 2*$xheight - $ascent - $descent;\n788,791c782,785\n\u003c \t\t    descent    =\u003e $descent,\n\u003c \t\t    lineheight =\u003e $lineheight,\n\u003c \t\t    xheight    =\u003e $xheight,\n\u003c \t\t    leading    =\u003e $leading};\n---\n\u003e                        descent    =\u003e $descent,\n\u003e                        lineheight =\u003e $lineheight,\n\u003e                        xheight    =\u003e $xheight,\n\u003e                        leading    =\u003e $leading};","files":null}]}